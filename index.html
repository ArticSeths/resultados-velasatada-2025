<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Apuestas - Fight Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 md:p-8">

    <!-- Header -->
    <header class="max-w-7xl mx-auto mb-10 text-center">
        <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-4">
            <i class="fas fa-fist-raised"></i> Registro de Apuestas
        </h1>
        <p class="text-slate-400 text-lg">C치lculo autom치tico de Parimutuel (Pozo de perdedores repartido entre ganadores)</p>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Columna Izquierda: Leaderboard Global -->
        <section class="lg:col-span-1">
            <div class="glass rounded-2xl p-6 sticky top-8 shadow-2xl shadow-purple-900/20">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-trophy text-yellow-400"></i> Clasificaci칩n General
                </h2>
                <div id="leaderboard" class="space-y-3">
                    <!-- Leaderboard se llena con JS -->
                </div>
            </div>
        </section>

        <!-- Columna Derecha: Detalle de Peleas -->
        <section class="lg:col-span-2 space-y-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-list-ul text-blue-400"></i> Historial de Combates
            </h2>
            <div id="fights-container" class="space-y-6">
                <!-- Peleas se llenan con JS -->
            </div>
        </section>

    </main>

    <script>
        // --- 1. DATOS DE ENTRADA ---
        // Aqu칤 transcribimos exactamente tus datos.
        const rawFights = [
            {
                title: "Pichon vs Ububu",
                winner: "Pichon",
                bets: [
                    { user: "WhodouVoodoo", amount: "50k", on: "Ububu" },
                    { user: "Alfo", amount: "100k", on: "Pichon" },
                    { user: "Jpthekit", amount: "200k", on: "Ububu" },
                    { user: "Eric_LOM", amount: "20k", on: "Pichon" },
                    { user: "Facolnest", amount: "200k", on: "Pichon" },
                    { user: "Ladislao", amount: "500k", on: "Ububu" },
                    { user: "Nijhitivi", amount: "200k", on: "Pichon" }
                ]
            },
            {
                title: "Zripht vs Ladislao",
                winner: "Ladislao",
                bets: [
                    { user: "WhodouVoodoo", amount: "50k", on: "Ladislao" },
                    { user: "Pichon9898", amount: "50k", on: "Zripht" },
                    { user: "Kuga2207", amount: "20k", on: "Zripht" },
                    { user: "Jpthekit", amount: "50k", on: "Ladislao" },
                    { user: "Nijhitivi", amount: "200k", on: "Ladislao" },
                    { user: "Facolnest", amount: "300k", on: "Zripht" },
                    { user: "Eric_LOM", amount: "50k", on: "Ladislao" }
                ]
            },
            {
                title: "Kuga vs Alfo",
                winner: "Alfo",
                bets: [
                    { user: "Zripht", amount: "400k", on: "Alfo" },
                    { user: "Ladislao", amount: "500k", on: "Alfo" },
                    { user: "WhodouVoodoo", amount: "100k", on: "Alfo" },
                    { user: "Nijhitivi", amount: "400k", on: "Kuga" },
                    { user: "Facolnest", amount: "200k", on: "Kuga" },
                    { user: "Eric_LOM", amount: "50k", on: "Kuga" },
                    { user: "Jpthekit", amount: "50k", on: "Kuga" },
                    { user: "Pichon9898", amount: "100k", on: "Alfo" }
                ]
            },
            {
                title: "JPtheKit vs Ladislao",
                winner: "JPtheKit",
                bets: [
                    { user: "Zripht", amount: "500k", on: "Ladislao" },
                    { user: "WhodouVoodoo", amount: "100k", on: "JPtheKit" },
                    { user: "Pichon9898", amount: "200k", on: "Ladislao" },
                    { user: "Nijhitivi", amount: "200k", on: "Ladislao" },
                    { user: "Facolnest", amount: "200k", on: "Ladislao" },
                    { user: "Kuga2207", amount: "20k", on: "JPtheKit" },
                    { user: "Alfo", amount: "200k", on: "JPtheKit" },
                    { user: "Eric_LOM", amount: "50k", on: "JPtheKit" }
                ]
            },
            {
                title: "Whodo vs Alfo",
                winner: "Whodo",
                bets: [
                    { user: "Pichon9898", amount: "200k", on: "Alfo" },
                    { user: "Facolnest", amount: "200k", on: "Whodo" },
                    { user: "Ladislao", amount: "69k", on: "Whodo" },
                    { user: "Nijhitivi", amount: "500k", on: "Whodo" },
                    { user: "Eric_LOM", amount: "50k", on: "Whodo" },
                    { user: "Kuga2207", amount: "40k", on: "Alfo" },
                    { user: "Jpthekit", amount: "50k", on: "Alfo" }
                ]
            },
            {
                title: "IBM vs Ciro",
                winner: "Ciro",
                bets: [
                    { user: "Facolnest", amount: "200k", on: "Ciro" },
                    { user: "Alfo", amount: "300k", on: "Ciro" },
                    { user: "WhodouVoodoo", amount: "100k", on: "IBM" },
                    { user: "Pichon9898", amount: "500k", on: "IBM" },
                    { user: "Nijhitivi", amount: "300k", on: "IBM" },
                    { user: "Kuga2207", amount: "80k", on: "IBM" },
                    { user: "Ladislao", amount: "100k", on: "IBM" },
                    { user: "Eric_LOM", amount: "50k", on: "IBM" }
                ]
            },
            {
                title: "Roi vs Nijhitivi",
                winner: "Nijhitivi",
                bets: [
                    { user: "WhodouVoodoo", amount: "100k", on: "Nijhitivi" },
                    { user: "Pichon9898", amount: "1M", on: "Nijhitivi" },
                    { user: "Kuga2207", amount: "200k", on: "Nijhitivi" },
                    { user: "Facolnest", amount: "300k", on: "Roi" },
                    { user: "Eric_LOM", amount: "50k", on: "Nijhitivi" },
                    { user: "Alfo", amount: "500k", on: "Roi" },
                    { user: "Ladislao", amount: "200k", on: "Roi" }
                ]
            },
            {
                title: "Pichon vs EricTheKit",
                winner: "EricTheKit",
                bets: [
                    { user: "Facolnest", amount: "300k", on: "Pichon" },
                    { user: "Alfo", amount: "400k", on: "EricTheKit" },
                    { user: "Kuga2207", amount: "50k", on: "Pichon" },
                    { user: "WhodouVoodoo", amount: "50k", on: "EricTheKit" }
                ]
            },
            {
                title: "JPTheKit vs Facolnest",
                winner: "JPTheKit",
                bets: [
                    { user: "WhodouVoodoo", amount: "200k", on: "JPTheKit" },
                    { user: "Ladislao", amount: "2M", on: "Facolnest" },
                    { user: "Pichon9898", amount: "1M", on: "Facolnest" },
                    { user: "Eric_LOM", amount: "100k", on: "JPTheKit" },
                    { user: "Kuga2207", amount: "200k", on: "JPTheKit" },
                    { user: "Zripht", amount: "3M", on: "JPTheKit" },
                    { user: "Nijhitivi", amount: "500k", on: "JPTheKit" }
                ]
            },
            {
                title: "Nijhitivi vs Alejandro",
                winner: "Nijhitivi",
                bets: [
                    { user: "WhodouVoodoo", amount: "100k", on: "Nijhitivi" },
                    { user: "Kuga2207", amount: "200k", on: "Nijhitivi" },
                    { user: "Pichon9898", amount: "2M", on: "Alejandro" },
                    { user: "Facolnest", amount: "500k", on: "Nijhitivi" },
                    { user: "Ladislao", amount: "200k", on: "Nijhitivi" },
                    { user: "Alfo", amount: "500k", on: "Nijhitivi" },
                    { user: "Jpthekit", amount: "50k", on: "Nijhitivi" },
                    { user: "Eric_LOM", amount: "100k", on: "Nijhitivi" }
                ]
            },
            {
                title: "Whodo vs Ciros",
                winner: "Ciros",
                bets: [
                    { user: "Facolnest", amount: "500k", on: "Whodo" },
                    { user: "Ladislao", amount: "500k", on: "Ciros" },
                    { user: "Pichon9898", amount: "3M", on: "Whodo" },
                    { user: "Eric_LOM", amount: "100k", on: "Whodo" },
                    { user: "Kuga2207", amount: "200k", on: "Whodo" },
                    { user: "Jpthekit", amount: "100k", on: "Whodo" },
                    { user: "Nijhitivi", amount: "600k", on: "Whodo" }
                ]
            },
            {
                title: "EricTheKit vs JPTheKit",
                winner: "JPTheKit",
                bets: [
                    { user: "Pichon9898", amount: "10M", on: "JPTheKit" },
                    { user: "Nijhitivi", amount: "1M", on: "JPTheKit" },
                    { user: "Perdi1412", amount: "500k", on: "EricTheKit" },
                    { user: "WhodouVoodoo", amount: "500k", on: "EricTheKit" },
                    { user: "Kuga2207", amount: "500k", on: "JPTheKit" },
                    { user: "Curtidor", amount: "1M", on: "EricTheKit" },
                    { user: "Facolnest", amount: "1M", on: "JPTheKit" },
                    { user: "Ladislao", amount: "750k", on: "EricTheKit" },
                    { user: "Zripht", amount: "500k", on: "EricTheKit" }
                ]
            },
            {
                title: "Nijhitivi vs Ciros",
                winner: "Nijhitivi",
                bets: [
                    { user: "Facolnest", amount: "1M", on: "Ciros" },
                    { user: "WhodouVoodoo", amount: "500k", on: "Nijhitivi" },
                    { user: "Pichon9898", amount: "10M", on: "Ciros" },
                    { user: "Kuga2207", amount: "500k", on: "Nijhitivi" },
                    { user: "Eric_LOM", amount: "500k", on: "Ciros" },
                    { user: "Alfo", amount: "1M", on: "Nijhitivi" },
                    { user: "Zripht", amount: "500k", on: "Nijhitivi" },
                    { user: "Ladislao", amount: "500k", on: "Nijhitivi" }
                ]
            },
            {
                title: "ErictheKit vs Ciros",
                winner: "Ciros",
                bets: [
                    { user: "Nijhitivi", amount: "1M", on: "Ciros" },
                    { user: "WhodouVoodoo", amount: "1M", on: "Ciros" },
                    { user: "Pichon9898", amount: "10M", on: "Ciros" },
                    { user: "Zripht", amount: "2M", on: "ErictheKit" },
                    { user: "Ladislao", amount: "1M", on: "ErictheKit" },
                    { user: "Kuga2207", amount: "1M", on: "ErictheKit" },
                    { user: "Alfo", amount: "1M", on: "ErictheKit" },
                    { user: "Facolnest", amount: "2M", on: "Ciros" }
                ]
            },
            {
                title: "JPTheKit vs Nijhitivi",
                winner: "Nijhitivi",
                bets: [
                    { user: "Curtidor", amount: "2M", on: "Nijhitivi" },
                    { user: "WhodouVoodoo", amount: "2M", on: "JPTheKit" },
                    { user: "Alfo", amount: "2M", on: "Nijhitivi" },
                    { user: "Kuga2207", amount: "1M", on: "JPTheKit" },
                    { user: "Eric_LOM", amount: "3M", on: "JPTheKit" },
                    { user: "Zripht", amount: "5M", on: "JPTheKit" },
                    { user: "Perdi1412", amount: "1M", on: "Nijhitivi" },
                    { user: "Ladislao", amount: "2M", on: "JPTheKit" },
                    { user: "Facolnest", amount: "2M", on: "JPTheKit" },
                    { user: "Pichon9898", amount: "10M", on: "Nijhitivi" }
                ]
            }
        ];

        // --- 2. FUNCIONES DE AYUDA ---

        // Normaliza cantidades (50k -> 50000, 1M -> 1000000)
        function parseAmount(str) {
            if (!str) return 0;
            const cleanStr = str.toLowerCase().replace(/,/g, '.').replace(/\s/g, '');
            let numeric = parseFloat(cleanStr);
            if (cleanStr.includes('m')) return numeric * 1000000;
            if (cleanStr.includes('k')) return numeric * 1000;
            return numeric; // Asumimos directo si no tiene letra
        }

        // Formato de moneda bonito
        const formatter = new Intl.NumberFormat('es-ES', {
            style: 'currency',
            currency: 'EUR',
            maximumFractionDigits: 0
        });

        // Formato corto para mostrar (1.2M, 500k)
        function formatShort(num) {
            if (Math.abs(num) >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (Math.abs(num) >= 1000) return (num / 1000).toFixed(0) + 'k';
            return num.toString();
        }

        // Normalizar nombres de usuario (para que "Jpthekit" == "JPTheKit")
        const userAliases = {
            "jpthekit": "JPTheKit",
            "jpdakit": "JPTheKit",
            "ericthekit": "EricTheKit",
            "eric": "EricTheKit",
            "whodo": "WhodouVoodoo",
            "whodoo": "WhodouVoodoo",
            "ciro": "Ciros",
            "ciross": "Ciros",
            "niji": "Nijhitivi",
            "tivi": "Nijhitivi",
            "nijithivi": "Nijhitivi"
        };
        
        function normalizeUser(name) {
            // Este mapa es para unificar display name final, usamos el mapa de arriba si el input fuera caotico,
            // pero en la variable rawFights ya est치n bastante limpios.
            // Aseguramos mayusculas consistentes
            const lower = name.toLowerCase().trim();
            if(lower === "jpthekit") return "JPTheKit";
            return name; 
        }

        // --- 3. L칍GICA DE C츼LCULO ---

        const userBalances = {}; // { user: totalBalance }

        // Inicializar balances
        rawFights.forEach(f => f.bets.forEach(b => {
            const user = normalizeUser(b.user);
            if (!userBalances[user]) userBalances[user] = 0;
        }));

        const fightsProcessed = rawFights.map((fight, index) => {
            let pot = 0;
            let totalWinningBets = 0;
            const winners = [];
            const losers = [];

            // 1. Calcular Botes
            fight.bets.forEach(bet => {
                const amount = parseAmount(bet.amount);
                // Normalizaci칩n de a qui칠n apuestan para match con winner
                let betOn = bet.on;
                // Ajustes manuales por inconsistencias de nombres en chat
                if(bet.on.toLowerCase().includes("eric")) betOn = "EricTheKit";
                if(bet.on.toLowerCase().includes("pichon")) betOn = "Pichon";
                if(bet.on.toLowerCase() === "ubu") betOn = "Ububu";
                if(bet.on.toLowerCase().includes("ladis")) betOn = "Ladislao";
                if(bet.on.toLowerCase().includes("zri")) betOn = "Zripht";
                if(bet.on.toLowerCase().includes("ciro")) betOn = "Ciros"; // Match winner name
                if(bet.on.toLowerCase().includes("ibm")) betOn = "IBM"; // Match winner name in logic if needed (was Ciro winner)
                if(bet.on.toLowerCase().includes("whodo")) betOn = "Whodo";
                if(bet.on.toLowerCase().includes("nij") || bet.on.toLowerCase().includes("tivi")) betOn = "Nijhitivi";
                if(bet.on.toLowerCase().includes("jp")) betOn = "JPTheKit";
                
                // Normalizar nombre de ganador para comparaci칩n
                let actualWinner = fight.winner;
                if(fight.winner === "Ciro") actualWinner = "Ciros"; 
                if(fight.winner === "EricTheKit") actualWinner = "EricTheKit";

                // Check simplificado: 쯃a apuesta contiene el string del ganador?
                // Ojo: "Ciro" vs "Ciros".
                const isWinner = betOn.toLowerCase().includes(fight.winner.toLowerCase()) || 
                                 (fight.winner === "Ciro" && betOn.toLowerCase().includes("ciro")) ||
                                 (fight.winner === "Ciros" && betOn.toLowerCase().includes("ciro")) ||
                                 (fight.winner === "Nijhitivi" && (betOn.toLowerCase().includes("nij") || betOn.toLowerCase().includes("tivi"))) ||
                                 (fight.winner === "EricTheKit" && betOn.toLowerCase().includes("eric"));


                if (isWinner) {
                    totalWinningBets += amount;
                    winners.push({ ...bet, numericAmount: amount, normalizedUser: normalizeUser(bet.user) });
                } else {
                    pot += amount;
                    losers.push({ ...bet, numericAmount: amount, normalizedUser: normalizeUser(bet.user) });
                }
            });

            // 2. Repartir
            const results = [];
            
            // Procesar Perdedores (Restar balance)
            losers.forEach(l => {
                userBalances[l.normalizedUser] -= l.numericAmount;
                results.push({
                    user: l.normalizedUser,
                    type: 'loss',
                    amount: -l.numericAmount
                });
            });

            // Procesar Ganadores (Sumar ganancia proporcional)
            winners.forEach(w => {
                let profit = 0;
                if (totalWinningBets > 0) {
                    const share = w.numericAmount / totalWinningBets;
                    profit = pot * share;
                }
                userBalances[w.normalizedUser] += profit;
                results.push({
                    user: w.normalizedUser,
                    type: 'win',
                    amount: profit,
                    betAmount: w.numericAmount
                });
            });

            return {
                ...fight,
                pot,
                totalWinningBets,
                results: results.sort((a, b) => b.amount - a.amount)
            };
        });

        // --- 4. RENDERIZADO ---

        // Render Leaderboard
        const leaderboardContainer = document.getElementById('leaderboard');
        const sortedUsers = Object.entries(userBalances).sort(([,a], [,b]) => b - a);

        sortedUsers.forEach(([user, balance], index) => {
            const div = document.createElement('div');
            const rank = index + 1;
            let rankClass = "bg-slate-700 text-slate-300";
            let icon = "";
            
            if (rank === 1) { rankClass = "bg-yellow-500 text-yellow-900 font-bold"; icon = "游녬"; }
            if (rank === 2) { rankClass = "bg-slate-300 text-slate-800 font-bold"; icon = "游볟"; }
            if (rank === 3) { rankClass = "bg-amber-600 text-amber-100 font-bold"; icon = "游볠"; }

            const balanceClass = balance >= 0 ? "text-emerald-400" : "text-rose-400";
            const formattedBalance = formatter.format(balance);

            div.className = "flex items-center justify-between p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800 transition";
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 flex items-center justify-center rounded-full ${rankClass}">
                        ${rank}
                    </div>
                    <span class="font-semibold text-lg">${icon} ${user}</span>
                </div>
                <div class="text-right">
                    <div class="${balanceClass} font-mono font-bold text-lg">${formattedBalance}</div>
                </div>
            `;
            leaderboardContainer.appendChild(div);
        });

        // Render Fights
        const fightsContainer = document.getElementById('fights-container');
        
        fightsProcessed.forEach((fight, idx) => {
            const card = document.createElement('div');
            card.className = "glass rounded-xl p-6 transition hover:border-purple-500/50";
            
            // Construir filas de tabla
            let tableRows = fight.results.map(r => {
                const colorClass = r.type === 'win' ? 'text-emerald-400' : 'text-rose-400';
                const sign = r.type === 'win' ? '+' : '';
                const bgRow = r.type === 'win' ? 'bg-emerald-900/10' : 'bg-rose-900/5';
                const detail = r.type === 'win' 
                    ? `<span class="text-xs text-slate-500">(Apost칩 ${formatShort(r.betAmount)})</span>` 
                    : `<span class="text-xs text-slate-500">Perdido</span>`;

                return `
                    <tr class="border-b border-slate-700/50 ${bgRow}">
                        <td class="py-2 px-2 font-medium">${r.user}</td>
                        <td class="py-2 px-2 text-right ${colorClass} font-mono">
                            ${sign}${formatShort(r.amount)}
                        </td>
                        <td class="py-2 px-2 text-right">${detail}</td>
                    </tr>
                `;
            }).join('');

            card.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b border-slate-700 pb-4">
                    <div>
                        <span class="text-slate-500 text-sm font-bold uppercase tracking-wider">Combate #${idx + 1}</span>
                        <h3 class="text-xl font-bold text-white">${fight.title}</h3>
                    </div>
                    <div class="mt-2 md:mt-0 text-right">
                        <div class="text-sm text-slate-400">Ganador</div>
                        <div class="text-xl font-bold text-purple-400">${fight.winner}</div>
                    </div>
                </div>
                
                <div class="mb-4 flex gap-4 text-sm">
                    <div class="bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                        游눯 Bote Perdedores: <span class="text-white font-mono">${formatShort(fight.pot)}</span>
                    </div>
                    <div class="bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                        游논 Apuestas Ganadoras: <span class="text-white font-mono">${formatShort(fight.totalWinningBets)}</span>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-slate-500 text-left">
                                <th class="pb-2 pl-2">Usuario</th>
                                <th class="pb-2 text-right">Resultado Neto</th>
                                <th class="pb-2 text-right">Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            fightsContainer.appendChild(card);
        });

    </script>
</body>
</html>
